<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Dialogflow Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .chat-container {
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .status-indicator {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.bot .message-bubble {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 6px;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.user .message-avatar {
            background: #f3f4f6;
            color: #374151;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .message-input:focus {
            border-color: #4facfe;
        }

        .send-button {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .send-button:hover {
            transform: scale(1.05);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .config-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 350px;
            z-index: 1000;
        }

        .toggle-config {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
        }

        .config-panel h3 {
            margin-bottom: 15px;
            color: #374151;
        }

        .config-field {
            margin-bottom: 15px;
        }

        .config-field label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
        }

        .config-field input, .config-field select {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <button class="toggle-config" onclick="toggleConfig()" id="configToggle">‚öôÔ∏è</button>
    
    <div class="config-panel" id="configPanel" style="display: none;">
        <h3>üîß Connect Your Dialogflow Bot</h3>
        <div class="config-field">
            <label>Your Project ID *</label>
            <input type="text" id="projectId" placeholder="my-chatbot-project-123">
            <small style="color: #6b7280; font-size: 11px;">Find this in your Dialogflow console</small>
        </div>
        <div class="config-field">
            <label>Session ID</label>
            <input type="text" id="sessionId" value="user-session-123">
            <small style="color: #6b7280; font-size: 11px;">Unique identifier for this conversation</small>
        </div>
        <div class="config-field">
            <label>Language Code</label>
            <select id="languageCode">
                <option value="en">English (en)</option>
                <option value="es">Spanish (es)</option>
                <option value="fr">French (fr)</option>
                <option value="de">German (de)</option>
                <option value="pt">Portuguese (pt)</option>
                <option value="it">Italian (it)</option>
                <option value="ja">Japanese (ja)</option>
                <option value="ko">Korean (ko)</option>
                <option value="zh">Chinese (zh)</option>
            </select>
        </div>
        <div class="config-field">
            <label>Integration Method</label>
            <select id="apiMethod">
                <option value="webhook">Webhook (Recommended)</option>
                <option value="rest">Direct REST API</option>
                <option value="mock">Demo Mode</option>
            </select>
            <small style="color: #6b7280; font-size: 11px;">Webhook is easier and more secure</small>
        </div>
        <div class="config-field" id="webhookField" style="display: none;">
            <label>Your Webhook URL</label>
            <input type="text" id="webhookUrl" placeholder="https://your-server.com/webhook">
            <small style="color: #6b7280; font-size: 11px;">Your backend endpoint that calls Dialogflow</small>
        </div>
        <button onclick="connectToDialogflow()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Connect to Your Bot</button>
        <button onclick="toggleConfig()" style="width: 100%; padding: 8px; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">Close</button>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <h1>AI Assistant</h1>
            <div class="status-indicator"></div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-avatar">ü§ñ</div>
                <div class="message-bubble">
                    üëã Hi! I'm ready to connect to your Dialogflow chatbot. Click the ‚öôÔ∏è button to get started!
                </div>
            </div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            <div class="message-avatar">ü§ñ</div>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
        
        <div class="chat-input">
            <div class="input-container">
                <input 
                    type="text" 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Type your message..."
                    disabled
                >
                <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22,2 15,22 11,13 2,9"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        class DialogflowChatbot {
            constructor() {
                this.config = {
                    projectId: '',
                    sessionId: 'user-session-123',
                    languageCode: 'en',
                    apiMethod: 'webhook',
                    webhookUrl: ''
                };
                this.initialized = false;
                this.setupEventListeners();
            }

            setupEventListeners() {
                const input = document.getElementById('messageInput');
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Show/hide webhook field based on method selection
                document.getElementById('apiMethod').addEventListener('change', (e) => {
                    const webhookField = document.getElementById('webhookField');
                    webhookField.style.display = e.target.value === 'webhook' ? 'block' : 'none';
                });
            }

            initialize(config) {
                this.config = { ...this.config, ...config };
                this.initialized = true;
                
                // Enable input
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendButton').disabled = false;
                
                const method = this.config.apiMethod;
                const projectInfo = method === 'webhook' ? 'Webhook Mode' : 
                                  method === 'rest' ? `Project: ${this.config.projectId}` : 'Demo Mode';
                
                this.addMessage('bot', `‚úÖ Connected to your Dialogflow bot! (${projectInfo})`);
                this.addMessage('bot', `üéØ Try asking me something - I'll use your trained intents and responses!`);
                
                return true;
            }

            async sendMessage(text) {
                if (!text) {
                    const input = document.getElementById('messageInput');
                    text = input.value.trim();
                    if (!text) return;
                    input.value = '';
                }

                // Add user message
                this.addMessage('user', text);
                
                // Show typing indicator
                this.showTyping(true);
                
                try {
                    let response;
                    if (this.config.apiMethod === 'webhook' && this.config.webhookUrl) {
                        response = await this.callWebhook(text);
                    } else if (this.config.apiMethod === 'rest' && this.config.projectId) {
                        response = await this.callDialogflowAPI(text);
                    } else {
                        response = await this.getMockResponse(text);
                    }
                    
                    // Hide typing indicator
                    this.showTyping(false);
                    
                    // Add bot response
                    this.addMessage('bot', response.fulfillmentText || response.message || response.reply);
                    
                } catch (error) {
                    this.showTyping(false);
                    this.addMessage('bot', `‚ùå Connection error: ${error.message}`, true);
                }
            }

            async callWebhook(text) {
                // Call your backend webhook that handles Dialogflow
                const response = await fetch(this.config.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: text,
                        sessionId: this.config.sessionId,
                        languageCode: this.config.languageCode
                    })
                });

                if (!response.ok) {
                    throw new Error(`Webhook Error: ${response.status} - Make sure your webhook is running and accessible`);
                }

                return await response.json();
            }

            async callDialogflowAPI(text) {
                // Direct API call to Dialogflow (requires authentication)
                const endpoint = `https://dialogflow.googleapis.com/v2/projects/${this.config.projectId}/agent/sessions/${this.config.sessionId}:detectIntent`;
                
                const requestBody = {
                    queryInput: {
                        text: {
                            text: text,
                            languageCode: this.config.languageCode
                        }
                    }
                };

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer YOUR_ACCESS_TOKEN' // You need to implement OAuth
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`Dialogflow API Error: ${response.status} - Check your authentication and project ID`);
                }

                const data = await response.json();
                return data.queryResult;
            }

            async getMockResponse(text) {
                // Demo responses that simulate your bot
                await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 1200));
                
                const responses = [
                    "This is a demo response! Connect your real Dialogflow bot to see your trained responses.",
                    "I'm running in demo mode. Your actual bot responses will appear here once connected.",
                    "Great question! In real mode, I'd use your Dialogflow intents to answer this.",
                    "Connect your Dialogflow bot to see how I'll actually respond to this!",
                    "Demo mode active. Your real bot would handle this query using your trained model."
                ];

                return { message: responses[Math.floor(Math.random() * responses.length)] };
            }

            addMessage(sender, text, isError = false) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;

                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = sender === 'bot' ? 'ü§ñ' : 'üë§';

                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = text;

                if (isError) {
                    bubble.style.background = '#fee2e2';
                    bubble.style.color = '#dc2626';
                    bubble.style.border = '1px solid #fecaca';
                }

                messageDiv.appendChild(avatar);
                messageDiv.appendChild(bubble);
                messagesContainer.appendChild(messageDiv);

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            showTyping(show) {
                const indicator = document.getElementById('typingIndicator');
                indicator.style.display = show ? 'flex' : 'none';
                
                if (show) {
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }
        }

        // Initialize chatbot instance
        const chatbot = new DialogflowChatbot();

        // Global functions
        function toggleConfig() {
            const panel = document.getElementById('configPanel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
        }

        function connectToDialogflow() {
            const config = {
                projectId: document.getElementById('projectId').value,
                sessionId: document.getElementById('sessionId').value,
                languageCode: document.getElementById('languageCode').value,
                apiMethod: document.getElementById('apiMethod').value,
                webhookUrl: document.getElementById('webhookUrl').value
            };

            // Validation
            if (config.apiMethod === 'rest' && !config.projectId) {
                alert('‚ùå Please enter your Dialogflow Project ID for REST API mode.');
                return;
            }

            if (config.apiMethod === 'webhook' && !config.webhookUrl) {
                alert('‚ùå Please enter your webhook URL for webhook mode.');
                return;
            }

            chatbot.initialize(config);
            toggleConfig(); // Close the config panel
        }

        function sendMessage() {
            chatbot.sendMessage();
        }
    </script>
</body>
</html>